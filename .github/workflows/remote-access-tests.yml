name: Remote Access Tests

on:
  push:
    branches: [main]
  pull_request: {}

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6
        with:
          lfs: true

      - name: Install common dependencies
        uses: ./.github/actions/common-deps

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Start LiveKit server
        run: docker compose up -d

      - name: Wait for LiveKit to be ready
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:7880 > /dev/null 2>&1; then
              echo "LiveKit is ready"
              exit 0
            fi
            echo "Waiting for LiveKit... ($i/30)"
            sleep 1
          done
          echo "LiveKit failed to start"
          docker compose logs
          exit 1

      - name: Run LiveKit integration tests
        run: cargo test -p remote-access-tests -- --ignored livekit_

      - name: Run auth integration tests
        if: ${{ !github.event.pull_request.head.repo.fork && github.actor != 'dependabot[bot]' }}
        run: cargo test -p remote-access-tests -- --ignored auth_
        env:
          FOXGLOVE_API_KEY: ${{ secrets.FOXGLOVE_API_KEY }}

      - name: Stop LiveKit server
        if: always()
        run: docker compose down
