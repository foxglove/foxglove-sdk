var f=EventTarget,p="https://embed.foxglove.dev/",c=[".bag",".mcap"],h=class extends f{#e;#n;#o;#s=!1;#t={dataSource:void 0,layout:void 0,extension:[]};#i=!1;constructor(e){super();let{parent:t,src:s,orgSlug:r,initialDataSource:o,initialLayout:n,initialExtensions:l,colorScheme:d="auto"}=e;this.#o=r;let a=s??p;try{this.#n=new URL(a)}catch{throw new Error(`[FoxgloveViewer] Invalid server URL: ${a}`)}window.addEventListener("message",this.#h),o&&this.setDataSource(o),n!=null&&this.setLayoutData(n),l&&this.installExtensions(l),this.#e=document.createElement("iframe"),this.#e.src=a,this.#e.title="Foxglove",this.#e.allow="cross-origin-isolated",this.#e.style.width="100%",this.#e.style.height="100%",this.#e.style.border="none",this.setColorScheme(d),t.appendChild(this.#e)}setDataSource(e){if(e.type==="live"){let t=this.#d(e.protocol,e.url);if(t)throw new Error(`[FoxgloveViewer] Error setting data source: ${t}`)}this.#r({type:"set-data-source",payload:e})}setLayoutData(e){this.#r({type:"set-layout",payload:e})}installExtensions(e){let t=e.find(s=>this.#l(s));if(t!=null)throw new Error(`[FoxgloveViewer] Error installing extension: ${this.#l(t)}`);this.#r({type:"install-extension",payload:e})}isReady(){return this.#s}destroy(){this.#i=!0,this.#e.remove(),window.removeEventListener("message",this.#h)}isDestroyed(){return this.#i}setColorScheme(e){this.#e.style.colorScheme=e==="auto"?"normal":e}#r(e){e.type==="install-extension"?this.#t.extension.push(e):e.type==="set-data-source"?this.#t.dataSource=e:this.#t.layout=e,this.#s&&this.#a(e)}#a(e){if(this.#i){console.warn("[FoxgloveViewer] Unable to post command. Frame has been destroyed.");return}g(this.#e.contentWindow,"Invariant: iframe should be loaded."),this.#e.contentWindow.postMessage(e,this.#n.href)}#d(e,t){switch(e){case"foxglove-websocket":case"rosbridge-websocket":return!t.startsWith("ws://")&&!t.startsWith("wss://")?"Invalid URL. The URL must start with ws:// or wss://.":void 0;case"remote-file":try{let s=t.split(".").pop();return!s||s.length===0?"Invalid URL. The URL must end with a filename and extension.":c.includes(`.${s}`)?void 0:`Invalid URL. Only ${new Intl.ListFormat("en-US",{style:"long"}).format(c)} files are supported.`}catch{return"Invalid URL."}}}#l(e){if(typeof e=="string"){let t=e.split(".").pop();if(!t||t.length===0)return"Invalid URL. The URL must end with a filename and extension.";if(t!=="foxe")return"Invalid extension. The extension must be a .foxe file."}else{let t=e.name.split(".").pop();if(!t||t.length===0||t!=="foxe")return"Invalid extension. The extension must be a .foxe file."}}#h=e=>{let t=new URL(e.origin);if(!(e.source!==this.#e.contentWindow||t.href!==this.#n.href)){if(this.#i){console.warn("[FoxgloveViewer] Unable to handle message. Frame has been destroyed.");return}switch(e.data.type){case"foxglove-origin-request":this.#a({type:"origin-ack"});break;case"foxglove-handshake-request":{this.#s=!0,this.#a({type:"handshake-ack",payload:{orgSlug:this.#o,initialDataSource:this.#t.dataSource?.payload,initialLayout:this.#t.layout?.payload,initialExtensions:this.#t.extension.flatMap(s=>s.payload)}});break}case"foxglove-handshake-complete":{this.dispatchEvent(new Event("ready"));break}case"foxglove-error":{this.dispatchEvent(new CustomEvent("error",{detail:e.data.payload}));break}default:{console.warn("[FoxgloveViewer] Unhandled message type:",e.data);break}}}}};function g(i,e="no additional info provided"){if(!i)throw new Error("Assertion Error: "+e)}function y({model:i,el:e}){function t(){let n=i.get("data");return{type:"file",file:w(n.buffer)}}function s(){let n=i.get("layout_data");return JSON.stringify(n)!=="{}"?n:void 0}let r=document.createElement("div"),o=new h({parent:r,src:i.get("src")!==""?i.get("src"):void 0,orgSlug:void 0,initialDataSource:t(),initialLayout:s()});r.style.width=i.get("width"),r.style.height=i.get("height"),i.on("change:width",()=>{r.style.width=i.get("width")}),i.on("change:height",()=>{r.style.height=i.get("height")}),i.on("change:data",()=>{let n=t();o.setDataSource(n)}),i.on("change:layout",()=>{let n=s();o.setLayoutData(n)}),e.appendChild(r)}function w(i){if(i.byteLength===0)return[];let e=new DataView(i),t=0,s=e.getUint32(t);t+=4;let r=[],o=new Uint8Array([0,255,0,255]);for(let n=0;n<s;n++){let l=new Uint8Array(i,t,4),d=e.getUint32(t+4);if(!x(l,o)||d!==n)throw new Error(`Invalid separator at position ${t}`);t+=8;let a=Number(e.getBigUint64(t));t+=8;let u=i.slice(t,t+a);if(u.byteLength!==a)throw new Error(`Expected ${a} bytes but got ${u.byteLength}`);r.push(new File([u],`data-${n}.mcap`)),t+=a}return r}function x(i,e){if(i.length!==e.length)return!1;for(let t=0;t<i.length;t++)if(i[t]!==e[t])return!1;return!0}var m={render:y};export{m as default};
